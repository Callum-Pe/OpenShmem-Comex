#!/bin/sh
# (c) University of Houston System.  All rights reserved.

#
# NB: this will turn into the GNU autotools setup at some point.
#

progname="`basename $0`"

# -- defaults --
prefix=/usr/local
gasnet_root=$prefix
gasnet_conduit=
cray_compat=FALSE
putget_nb=FALSE
debug=FALSE
trace=FALSE
# -- end defaults --

libdir=
modulesdir=

tell()
{
  echo "$progname: $*"
}

show_usage()
{
    if [ $# -gt 0 ]
    then
	tell ""
	tell "unknown option \"$@\""
	tell ""
    fi
    cat <<__EOT__
Usage: $progname [options]

  Installation choices:

    --prefix=PREFIX              Install to directory root PREFIX
    --with-libdir=DIR            Libraries installed to DIR
    --with-modulesdir=DIR        Pluggable modules installed to DIR
    --with-gasnet-root=G         GASNet installed under directory "G"
    --with-gasnet-conduit=C      Use GASNet conduit "C"

  Optional features:

    --enable-debug               Run-time debugging checks
    --disable-debug              No run-time debugging checks

    --enable-trace               Run-time traces
    --disable-trace              No run-time traces

    --enable-cray-compat         Subroutine synonyms for the Cray SHMEM
    --disable-cray-compat        No subroutine synonyms for the Cray SHMEM

    --enable-putget-nb           Non-blocking extensions
    --disable-putget-nb          No non-blocking extensions

    --help                       Show this summary and exit

__EOT__
}

# ------------------------------------------------------------------------------
#
# parse command line
#

for o in $@
do
    case $o in
	--prefix=*)
	    prefix="`echo $o | sed 's/--prefix=//'`"
	    ;;
	--with-libdir=*)
	    libdir="`echo $o | sed 's/--with-libdir=//'`"
	    ;;
	--with-modulesdir=*)
	    modulesdir="`echo $o | sed 's/--with-modulesdir=//'`"
	    ;;
	--with-gasnet-root=*)
	    gasnet_root="`echo $o | sed 's/--with-gasnet-root=//'`"
	    ;;
	--with-gasnet-conduit=*)
	    gasnet_conduit="`echo $o | sed 's/--with-gasnet-conduit=//'`"
	    ;;
	--enable-debug)
	    debug=TRUE
	    ;;
	--disable-debug)
	    debug=FALSE
	    ;;
	--enable-trace)
	    trace=TRUE
	    ;;
	--disable-trace)
	    trace=FALSE
	    ;;
	--enable-cray-compat)
	    cray_compat=TRUE
	    ;;
	--disable-cray-compat)
	    cray_compat=FALSE
	    ;;
	--enable-putget-nb)
	    putget_nb=TRUE
	    ;;
	--disable-putget-nb)
	    putget_nb=FALSE
	    ;;
	--help)
	    show_usage
	    exit 0
	    ;;
	*)
	    show_usage $o
	    exit 1
	    ;;
    esac
done

if [ -z "$gasnet_root" ]
then
    tell "I don't know where GASNet is installed"
    exit 1
fi
if [ ! -r "$gasnet_root/include/gasnet.h" ]
then
    tell "I can't find a GASNet installation in \"$gasnet_root\""
    tell "  (no gasnet.h header file)"
    exit 1
fi

KNOWN_CONDUITS="`( cd $gasnet_root/include; echo *-conduit |
                   sed -e 's/-conduit//g' )`"

if [ -z "$gasnet_conduit" ]
then
    tell "I don't know which GASNet conduit to use."
    if [ -z "$KNOWN_CONDUITS" ]
    then
        tell "I couldn't find any GASNet conduits under $gasnet_root"
    else
        tell "I found the following conduits: \"$KNOWN_CONDUITS\""
    fi
    exit 1
fi

[ -z "$libdir" ] && libdir=$prefix/lib
[ -z "$modulesdir" ] && modulesdir=$libdir/modules

# -- ok, gasnet there, check compilers (default to GNU for now) --

cc_cmd=${CC-cc}
cpp_flags=${CPPFLAGS-""}
c_flags=${CFLAGS-"-g"}
ld_cmd=${LD-$cc_cmd}
ld_flags=${LDFLAGS-""}
cxx_cmd=${CXX-c++}
cxx_flags=${CXXFLAGS-"-g"}
fc_cmd=${FC-f90}
fc_flags=${FCFLAGS-"-g"}

tell "C compiler is                 \"$cc_cmd\""
tell "C pre-processor flags are     \"$cpp_flags\""
tell "C flags are                   \"$c_flags\""
tell "C++ compiler is               \"$cxx_cmd\""
tell "C++ flags are                 \"$cxx_flags\""
tell "Fortran compiler is           \"$fc_cmd\""
tell "Fortran flags are             \"$fc_flags\""
tell "linker is                     \"$ld_cmd\""
tell "linker flags are              \"$ld_flags\""
tell ""
tell "installing OpenSHMEM to       \"$prefix\""
tell "installing libraries to       \"$libdir\""
tell "installing modules to         \"$modulesdir\""
tell ""
tell "using GASNet in               \"$gasnet_root\""
tell "using conduit                 \"$gasnet_conduit\""
tell ""
tell "Debug is                      $debug"
tell "Trace is                      $trace"
tell "Cray compatibility is         $cray_compat"
tell "Non-blocking extensions are   $putget_nb"
tell ""
tell "-------------------------------------------------------------"
tell ""

find . -name Makefile.in -print |
while read mfin
do
  mf="`echo $mfin | sed -e 's/\.in$//'`"
  sed \
    -e "s%@CC@%$cc_cmd%g" \
    -e "s%@CPPFLAGS@%$cpp_flags%g" \
    -e "s%@CFLAGS@%$c_flags%g" \
    -e "s%@CXX@%$cxx_cmd%g" \
    -e "s%@CXXFLAGS@%$cxx_flags%g" \
    -e "s%@FC@%$fc_cmd%g" \
    -e "s%@FCFLAGS@%$fc_flags%g" \
    -e "s%@LD@%$ld_cmd%g" \
    -e "s%@LDFLAGS@%$ld_flags%g" \
    -e "s%@GASNET_ROOT@%$gasnet_root%g" \
    -e "s%@GASNET_CONDUIT@%$gasnet_conduit%g" \
    -e "s%@CRAY_COMPAT@%$cray_compat%g" \
    -e "s%@PUTGET_NB@%$putget_nb%g" \
    -e "s%@DEBUG@%$debug%g" \
    -e "s%@TRACE@%$trace%g" \
    -e "s%@PREFIX@%$prefix%g" \
    -e "s%@LIB_DIR@%$libdir%g" \
    -e "s%@MODULES_DIR@%$modulesdir%g" \
    $mfin > $mf
  tell "created $mf from $mfin"
done

cs=config.status
tmpcs=`mktemp`
cat > $tmpcs <<_EOT_
#!/bin/sh
#
# generated by $progname, do not edit directly
#

CC="$cc_cmd"
CPPFLAGS="$cpp_flags"
CFLAGS="$c_flags"
CXX="$cxx_cmd"
CXXFLAGS="$cxx_flags"
FC="$fc_cmd"
FCFLAGS="$fc_flags"
LD="$ld_cmd"
LDFLAGS="$ld_flags"

export CC
export CXX
export FC
export CPPFLAGS
export CFLAGS
export CXXFLAGS
export FCFLAGS
export LD
export LDFLAGS

$0 $@
_EOT_
cp $tmpcs $cs
rm -f $tmpcs
chmod +x $cs
tell ""
tell "saved configuration in $cs"
