#!/bin/sh

#
# NB: this will turn into the GNU autotools setup at some point.
#

progname="`basename $0`"

# -- defaults --
prefix=/usr/local
gasnet_root=$prefix
gasnet_conduit=mpi
cray_compat=FALSE
putget_nb=FALSE
# -- end defaults --

show_usage()
{
    if [ $# -gt 0 ]; then
	echo ""
	echo "$progname: unknown option \"$@\""
	echo ""
    fi
    echo "Usage: $progname [options]"
    echo ""
    echo "    --prefix=PREFIX         Install to directory root PREFIX"
    echo "    --with-gasnet-root=G    GASNet installed under directory \"G\""
    echo "    --with-gasnet-conduit=C Use GASNet conduit \"C\""
    echo ""
    echo "    --enable-cray-compat    Subroutine synonyms for the Cray SHMEM"
    echo "    --enable-putget-nb      Enable the non-blocking extensions"
    echo ""
    echo "    --help                  Show this summary and exit"
    echo ""
}

for o in $@; do
    case $o in
	--prefix=*)
	    prefix="`echo $o | sed 's/--prefix=//'`"
	    ;;
	--with-gasnet-root=*)
	    gasnet_root="`echo $o | sed 's/--with-gasnet-root=//'`"
	    ;;
	--with-gasnet-conduit=*)
	    gasnet_conduit="`echo $o | sed 's/--with-gasnet-conduit=//'`"
	    ;;
	--enable-cray-compat)
	    cray_compat=TRUE
	    ;;
	--disable-cray-compat)
	    cray_compat=FALSE
	    ;;
	--enable-putget-nb)
	    putget_nb=TRUE
	    ;;
	--disable-putget-nb)
	    putget_nb=FALSE
	    ;;
	--help)
	    show_usage
	    exit 0
	    ;;
	*)
	    show_usage $o
	    exit 1
	    ;;
    esac
done

if [ ! -r "$gasnet_root/include/gasnet.h" ]; then
    echo "$progname: can't find GASNet installation in \"$gasnet_root\""
    echo "$progname: (no gasnet.h header file)"
    exit 1
fi

# -- ok, gasnet there, check compilers (default to GNU for now) --

cc_cmd=${CC-cc}
cpp_flags=${CPPFLAGS-""}
c_flags=${CFLAGS-"-g"}
ld_cmd=${LD-$cc_cmd}
ld_flags=${LDFLAGS-""}
cxx_cmd=${CXX-c++}
cxx_flags=${CXXFLAGS-"-g"}
fc_cmd=${FC-f90}
fc_flags=${FCFLAGS-"-g"}

echo "$progname: C compiler is \"$cc_cmd\""
echo "$progname: C pre-processor flags are \"$cpp_flags\""
echo "$progname: C flags are \"$c_flags\""
echo "$progname: C++ compiler is \"$cxx_cmd\""
echo "$progname: C++ flags are \"$cxx_flags\""
echo "$progname: Fortran compiler is \"$fc_cmd\""
echo "$progname: Fortran flags are \"$fc_flags\""
echo "$progname: linker is \"$ld_cmd\""
echo "$progname: linker flags are \"$ld_flags\""
echo "$progname:"

echo "$progname: installing to directory \"$prefix\""
echo "$progname: using GASNet in \"$gasnet_root\""
echo "$progname: using conduit \"$gasnet_conduit\""
echo "$progname:"
echo "$progname: Cray compatibility is $cray_compat"
echo "$progname: Non-blocking extensions are $putget_nb"
echo "$progname:"
echo "$progname: ---------------------------------------"

REWRITE_DIRS="
.
./doc
./src
./src/comms
./src/dlmalloc
./examples
./examples/C
./examples/C++
./examples/Fortran
"

for d in $REWRITE_DIRS; do
    mf="$d/Makefile"
    mfin="$mf.in"
    sed \
	-e "s%@CC@%$cc_cmd%g" \
	-e "s%@CPPFLAGS@%$cpp_flags%g" \
	-e "s%@CFLAGS@%$c_flags%g" \
	-e "s%@CXX@%$cxx_cmd%g" \
	-e "s%@CXXFLAGS@%$cxx_flags%g" \
	-e "s%@FC@%$fc_cmd%g" \
	-e "s%@FCFLAGS@%$fc_flags%g" \
	-e "s%@LD@%$ld_cmd%g" \
	-e "s%@LDFLAGS@%$ld_flags%g" \
	-e "s%@PREFIX@%$prefix%g" \
	-e "s%@GASNET_ROOT@%$gasnet_root%g" \
	-e "s%@GASNET_CONDUIT@%$gasnet_conduit%g" \
	-e "s%@CRAY_COMPAT@%$cray_compat%g" \
	-e "s%@PUTGET_NB@%$putget_nb%g" \
	< $mfin > $mf
    echo "$progname: created $mf from $mfin"
done

cs=config.status
cat > $cs <<_EOT_
#!/bin/sh
#
# generated by $progname, do not edit directly
#

CC="$cc_cmd"
CPPFLAGS="$cpp_flags"
CFLAGS="$c_flags"
CXX="$cxx_cmd"
CXXFLAGS="$cxx_flags"
FC="$fc_cmd"
FCFLAGS="$fc_flags"
LD="$ld_cmd"
LDFLAGS="$ld_flags"

export CC CXX FC
export CPPFLAGS CFLAGS CXXFLAGS FCFLAGS
export LD LDFLAGS

echo $0 $@

$0 $@
_EOT_
chmod +x $cs
echo "$progname: saved configuration in $cs"
