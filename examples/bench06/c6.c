/*-------------------------------------------------------------------------
*  C6 checks the solutions found by P6 and fills the checks array
*  If slen is not SLEN1=10000000 or SLEN2=1000000, cnterr = -1.
*  If slen is checkable, check that counts match to stored values:
*    if matches bad,                  cnterr = 1
*    if matches ok but gmatches bad,  cnterr = 2
*    if both ok but nindep bad,       cnterr = 3
*  In any case, each PE checks the sol's it found in P6.
*  If indep(m) = 1, so m-th set of eq's is indep,
*    checks(m) = number of eq's in this set that don't check mod 2 (0 is good)
*  solerrs = number of indep systems whose solution doesn't check
*------------------------------------------------------------------------*/
 
#include "bench6.h"

/* defined here to make them "symmetric" so remotely accessible by shmem ops */
int solerrs = 0;
int all;
int pWrk[_SHMEM_REDUCE_SYNC_SIZE];
/* int pWrk[MAXMATCH0/2 + 1]; */
long pSync[_SHMEM_REDUCE_SYNC_SIZE];

/* use macros to address multi-dim arrays with variable dim's like Fortran */
/* eqs[gmatches][msize][eqnw] */
#define eqs(I,J,K)	eqs[ (K) + eqnw * ( (J) + (msize * (I)) ) ]
/* sols[gmatches][eqnw] */
#define sols(I,J)	sols[ (J) + (eqnw * (I)) ]


static char cvs_info[] = "BMARKGRP $Date: 2005/09/20 14:55:38 $ $Revision: 1.3 $ $RCSfile: c6.c,v $ $Name:  $";

extern int popcnt(); /* utils.c */

void
c6( int loop, int slen,
	uint64 * eqs,
	uint64 * sols,
	int msize, int eqnw,
	int * indep,
	int * checks,
	int * pnindep,  /* (addr of symmetric var) */
	int loopinfo[MAXLOOPS][5],
	int mype, int npes,
	int matches, int gmatches,
	uint64 * firstsol,
	int * solindx )
{
   int wsmask = WSMASK;

   const int slen1 = 10000000;
   const int slen2 = 1000000;
 
   int cnterr = 0;
   uint64 bbit;
   int axsumj, m, j, i, checkbit_sum;
   int ntasks, mystart, mystop, extra;
   int nindep;

/* Data for the case slen = 10 000 000 (SLEN1): */
   int ckmatch1[MAXLOOPS] =
	{ 328, 300, 283, 337, 310, 299, 300, 309, 310, 289,
	  291, 311, 298, 296, 284, 310, 318, 316, 313, 307,
	  290, 311, 306, 339, 305, 303, 310, 307, 304, 301,
	  299, 281, 331, 276, 348, 282, 295, 321, 252, 314,
	  318, 279, 313, 302, 307, 313, 326, 284, 299, 328,
	  292, 318, 313, 317, 309, 292, 311, 331, 283, 313,
	  292, 305, 338, 286, 289, 304, 267, 320, 325, 292,
	  285, 302, 314, 330, 286, 318, 315, 319, 279, 325,
	  304, 315, 314, 297, 304, 328, 291, 352, 329, 306,
	  302, 313, 286, 282, 313, 277, 321, 312, 312, 302,
	  305, 305, 317, 294, 319, 310, 287, 286, 294, 300,
	  297, 313, 308, 321, 302, 327, 316, 331, 318, 305,
	  323, 350, 287, 287, 301, 304, 290, 312, 303, 276,
	  311, 326, 301, 307, 314, 323, 300, 283, 302, 269,
	  309, 290, 299, 301, 320, 296, 305, 333, 299, 316,
	  291, 301, 323, 327, 294, 332, 299, 338, 319, 335,
	  305, 325, 311, 304, 298, 307, 299, 302, 310, 303,
	  318, 291, 311, 287, 344, 303, 308, 296, 301, 270,
	  325, 329, 297, 281, 279, 286, 312, 328, 314, 305,
	  301, 311, 296, 335, 319, 323, 268, 270, 329, 302,
	  298, 319, 312, 274, 305, 297, 299, 316, 307, 292,
	  327, 287, 345, 327, 311, 320, 311, 320, 313, 316,
	  307, 302, 337, 286, 310, 299, 322, 308, 288, 307,
	  315, 316, 313, 312, 310, 317, 287, 312, 325, 290,
	  303, 285, 311, 287, 303, 319, 299, 324, 314, 310,
	  295, 323, 319, 297, 294, 293, 305, 336, 357, 314,
	  291, 311, 305, 328, 299, 299, 296, 339, 310, 279,
	  315, 294, 314, 308, 337, 309, 314, 271, 295, 344,
	  297, 291, 289, 330, 308, 290, 301, 330, 307, 300,
	  305, 270, 313, 301, 315, 293, 327, 291, 311, 334,
	  308, 264, 279, 298, 324, 304, 349, 277, 315, 296,
	  291, 310, 275, 309, 301, 295, 337, 278, 301, 277,
	  315, 307, 322, 336, 334, 299, 318, 306, 314, 286,
	  345, 318, 287, 337, 311, 316, 304, 320, 344, 305,
	  332, 303, 330, 335, 288, 285, 298, 295, 313, 312,
	  336, 298, 302, 316, 296, 299, 342, 293, 308, 303,
	  285, 266, 300, 304, 310, 318, 311, 306, 305, 285,
	  290, 302, 329, 305, 286, 301, 281, 300, 288, 274,
	  310, 344, 295, 314, 314, 268, 326, 300, 306, 312,
	  331, 311, 321, 336, 305, 288, 276, 321, 299, 298 };
   int ckindep1[MAXLOOPS] =
	{  87,  80,  86, 104,  96,  77,  88,  77,  84,  78,
	   72,  77,  88,  93,  81,  79,  90,  94,  91,  81,
	   73,  93,  89, 111,  83,  75,  96,  79,  77,  76,
	   87,  79,  87,  59, 100,  65,  81, 101,  60,  85,
	   97,  73,  96, 105,  75,  91,  92,  72,  74,  84,
	   86,  89,  69,  93,  76,  64,  82,  83,  79,  90,
	   79,  79,  99,  71,  70,  91,  68,  80,  94,  87,
	   80,  83,  95,  89,  81,  86,  80,  87,  70,  89,
	   90,  79,  97,  83,  92,  90,  82, 103,  80,  83,
	   67,  95,  82,  90,  86,  73,  88,  99,  77,  91,
	   77,  68,  82,  75,  83,  69,  67,  87,  90,  88,
	   89,  86,  82,  89,  73,  81,  90,  78,  80,  79,
	   76,  90,  92,  69,  82,  73,  79,  88,  87,  91,
	   97,  98,  86,  92,  89,  96,  81,  77,  81,  62,
	  107,  79,  79,  74,  94,  75,  90, 107,  75,  82,
	   77, 102,  95,  89,  87,  94,  72, 103,  86,  98,
	   91, 100,  95,  83,  84,  83,  97,  90,  88,  77,
	   72,  78,  92,  92,  96,  79,  73,  79,  81,  76,
	   86,  90,  87,  87,  76,  81,  77, 102,  86,  79,
	   92,  78,  70, 100,  96,  94,  77,  85,  94,  84,
	   80,  83,  92,  73,  70,  73,  87,  87,  85,  78,
	   91,  68,  91,  89,  73,  92,  88, 100,  83,  93,
	   88,  81,  89,  79,  90,  79,  85,  90,  64,  77,
	   92,  86,  84,  78,  78,  92,  78,  96,  92,  80,
	   73,  69,  84,  70,  80,  82,  82,  89,  89,  77,
	   91,  79,  83,  83,  88,  71,  85, 106,  99,  87,
	   77,  99,  82, 100,  83,  85,  77,  80,  76,  87,
	   79,  63,  67,  87, 100,  93,  84,  70,  83,  99,
	   78,  88,  74,  86,  86,  76,  76,  85,  79,  90,
	   82,  71,  91,  84,  85, 100,  91,  89,  78,  87,
	   75,  77,  78,  89,  96,  68,  82,  76,  69,  84,
	   74,  85,  61,  82,  85,  79, 104,  74,  68,  83,
	   74,  79,  69,  92,  93,  76,  91,  98,  97,  76,
	  112,  88,  89,  93,  84,  91,  80,  72,  96,  92,
	   95,  87,  85,  95,  64,  79,  75,  89,  87,  82,
	   73,  87,  75,  94,  80,  70,  88,  85,  92,  91,
	   74,  70,  88,  86,  75,  80,  84,  90,  86,  70,
	   77,  79,  96,  88,  78,  85,  77,  82,  87,  73,
	   83,  99,  74,  78,  83,  67,  92,  89,  82,  85,
	   96,  89,  94,  94,  74,  63,  94,  83,  83,  74 };
   int ckdep1[MAXLOOPS] =
	{ 225, 209, 191, 222, 196, 203, 203, 215, 216, 201,
	  200, 219, 202, 184, 188, 221, 211, 209, 203, 211,
	  203, 198, 202, 209, 209, 215, 200, 211, 208, 213,
	  193, 187, 229, 205, 222, 206, 199, 200, 178, 220,
	  214, 194, 200, 181, 216, 208, 220, 198, 215, 230,
	  191, 212, 225, 209, 218, 210, 217, 230, 188, 209,
	  198, 203, 224, 198, 200, 196, 193, 224, 219, 188,
	  193, 204, 206, 220, 193, 211, 224, 218, 194, 218,
	  195, 218, 205, 199, 199, 223, 197, 236, 229, 213,
	  219, 199, 193, 178, 210, 185, 219, 201, 216, 201,
	  210, 227, 221, 205, 220, 221, 205, 182, 192, 196,
	  193, 208, 205, 219, 209, 225, 204, 232, 224, 217,
	  233, 241, 183, 208, 203, 215, 202, 209, 207, 178,
	  196, 211, 198, 205, 208, 216, 209, 190, 208, 194,
	  192, 189, 200, 211, 208, 210, 202, 211, 205, 213,
	  202, 192, 216, 216, 193, 224, 213, 220, 209, 216,
	  201, 214, 208, 201, 198, 217, 188, 197, 207, 210,
	  227, 200, 198, 184, 232, 211, 214, 205, 209, 180,
	  225, 215, 197, 185, 188, 190, 213, 215, 211, 216,
	  190, 209, 213, 219, 207, 210, 177, 175, 221, 206,
	  208, 222, 201, 186, 224, 207, 200, 218, 206, 204,
	  221, 199, 238, 223, 215, 211, 210, 210, 220, 214,
	  204, 213, 229, 196, 208, 207, 221, 205, 210, 217,
	  208, 215, 210, 215, 207, 207, 197, 202, 220, 200,
	  217, 198, 210, 195, 203, 225, 197, 215, 212, 220,
	  189, 228, 223, 201, 186, 205, 205, 210, 246, 212,
	  203, 200, 203, 213, 195, 200, 200, 242, 217, 180,
	  220, 219, 234, 206, 217, 199, 208, 194, 202, 230,
	  207, 187, 202, 230, 207, 203, 206, 228, 212, 197,
	  212, 191, 201, 201, 210, 176, 214, 189, 221, 236,
	  213, 170, 191, 199, 209, 230, 246, 187, 230, 195,
	  204, 208, 197, 205, 199, 204, 223, 193, 206, 181,
	  224, 210, 235, 233, 222, 205, 212, 198, 202, 190,
	  216, 213, 189, 225, 206, 219, 213, 231, 234, 198,
	  215, 200, 230, 218, 210, 193, 208, 193, 207, 211,
	  244, 193, 207, 203, 199, 222, 241, 192, 202, 201,
	  191, 186, 201, 205, 224, 221, 207, 201, 204, 203,
	  195, 207, 218, 196, 182, 200, 193, 205, 189, 180,
	  214, 225, 205, 229, 217, 189, 210, 193, 214, 214,
	  222, 209, 207, 227, 217, 204, 175, 225, 200, 207 };

/* Data for the case slen = 1 000 000 (SLEN2): */
   int ckmatch2[100] =
	{  32,  28,  30,  31,  29,  26,  40,  30,  33,  28,
	   26,  34,  26,  27,  21,  23,  34,  35,  35,  34,
	   31,  33,  28,  34,  31,  23,  32,  28,  26,  33,
	   29,  34,  26,  24,  36,  28,  32,  39,  21,  54,
	   33,  25,  25,  30,  29,  26,  35,  28,  28,  30,
	   29,  31,  34,  42,  28,  35,  30,  29,  28,  32,
	   30,  26,  36,  33,  28,  33,  27,  40,  39,  22,
	   35,  26,  20,  30,  36,  30,  22,  26,  28,  28,
	   34,  30,  24,  29,  36,  34,  32,  43,  33,  36,
	   25,  30,  32,  30,  28,  22,  28,  26,  29,  33 };
   int ckindep2[100] =
	{   4,   2,   6,   4,   6,   8,   6,   3,   6,   2,
	    4,   3,   7,   8,   4,   1,   4,   4,   2,   5,
	    4,   3,   7,   3,   4,   2,   6,   4,   2,   8,
	    8,   5,   4,   4,   4,   3,   3,   8,   2,   8,
	    4,   4,   2,  10,   7,   3,   6,   3,   1,   3,
	    3,  10,   6,   6,   4,   8,   4,   2,   5,   4,
	    7,   6,   4,   1,   4,  11,   4,   8,   6,   5,
	    6,   5,   3,   1,   7,   8,   2,   1,   1,   5,
	   10,   3,   1,   2,   1,   3,   4,  13,   5,   6,
	    4,   1,   6,   5,   1,   5,   2,   8,   0,   8 };
   int ckdep2[100] =
	{  12,  13,  11,   9,  11,   6,  20,   7,  13,   9,
	    9,  16,   5,  10,   5,  12,  12,   7,  16,   9,
	   14,  10,  10,  12,  13,   8,   9,  11,  11,  14,
 	    8,  14,  13,   7,  13,  14,  13,  10,   8,  20,
	   12,  10,   9,  11,   9,  11,  12,  10,  12,  11,
	   15,  11,   9,  14,   8,  13,   9,  13,  10,  12,
 	    8,  11,  13,  17,  11,   5,  10,  10,  12,   8,
	   15,   4,   5,  14,  13,   9,   7,   6,  14,   7,
	   11,  13,  10,  14,  12,   4,  14,  10,  12,  13,
 	    8,  12,  10,  11,  14,  11,  12,   8,  12,   9 };

/*-------------------------------------------------------------------------
*  First check that slen is checkable and that the counts are correct
*  The nindep counts are still distributed among the PE's
*------------------------------------------------------------------------*/
   for (i=0; i<_SHMEM_REDUCE_SYNC_SIZE; ++i)
      pSync[i] = _SHMEM_SYNC_VALUE;
   shmem_barrier_all();

   if ( npes > 1 )
   {
      shmem_int_sum_to_all ( &all, pnindep, 1, 0,0,npes, pWrk, pSync );
      nindep = all;
   }
   else
      nindep = *pnindep;

   if ( slen == slen1 )
   {
      if ( matches != ckmatch1[loop] )
         cnterr = 1;
      else
      if ( nindep != ckindep1[loop] )
         cnterr = 2;
      else
      if ( (gmatches-nindep) != ckdep1[loop] )
         cnterr = 3;
   }
   else
   if ( slen == slen2 )
   {
      if ( matches != ckmatch2[loop] )
         cnterr = 1;
      else
      if ( nindep != ckindep2[loop] )
         cnterr = 2;
      else
      if ( (gmatches-nindep) != ckdep2[loop] )
         cnterr = 3;
   }
   else
   {
         cnterr = -1;	/* slen not checkable */
   }

/*-------------------------------------------------------------------------
*  distribute sets of equations in even chunks among the PE's (same as in P6)
*------------------------------------------------------------------------*/
   ntasks  = gmatches/npes;
   extra   = gmatches - ntasks * npes;
   mystart =  mype    * ntasks     + min ( mype, extra );
   mystop  = (mype+1) * ntasks - 1 + min ( mype+1, extra );
 
/*-------------------------------------------------------------------------
*  go  through my chunk of sets of equations
*------------------------------------------------------------------------*/
   /* bit pos for msize+1 bit in sol */
   bbit = (uint64)1 << (msize & wsmask);

   *solindx = -1;

   for ( m = mystart; m <= mystop; ++m )
   {
      /* skip if equations are dependent, or too few bits to have eq's */

      if ( indep[m] == 1 )
      {
         if (*solindx == -1)
         {
            *solindx = m;
            for ( i = 0; i < eqnw; i++ )
               firstsol[i] = sols(m,i);
         }

         /* add a 1 at end of sol[m], for the constant term in the eq's */
         sols(m, eqnw-1) |= bbit;
 
         /* checkbit_sum counts # of eq's in system that don't check mod 2 */
         checkbit_sum = 0;
         for ( j = 0; j < msize; ++j )
         {
            axsumj = 0;
            for ( i = 0; i < eqnw; ++i )
               axsumj += popcnt( eqs(m,j,i) & sols(m,i) );
            checkbit_sum += axsumj & 1;
         }
 
         checks[m] = checkbit_sum;

         if ( checkbit_sum != 0 )  ++solerrs;

         /* put last bit of sol[m] back to 0 */
         sols(m, eqnw-1) ^= bbit;
      }
   }  /* end loop on m for my chunk */

   if ( npes > 1 )
   {
      shmem_int_sum_to_all ( &all, &solerrs, 1, 0,0,npes, pWrk, pSync );
      solerrs = all;
   }

/* collect loopifo for R6 */
   loopinfo[loop][0] = matches;
   loopinfo[loop][1] = nindep;
   loopinfo[loop][2] = gmatches - nindep;
   loopinfo[loop][3] = cnterr;
   loopinfo[loop][4] = solerrs;
}
